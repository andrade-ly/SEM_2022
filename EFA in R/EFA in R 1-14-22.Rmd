---
title: "EFA in lavaan"
output: pdf_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60), tidy=TRUE)
options(scipen=999)

```

# lavaan (LAatent VAriable ANalysis)

Full documentation available at 
(https://cran.r-project.org/web/packages/lavaan/lavaan.pdf)

## Some Useful lavaan Notations

The "=~" operator can be used to define (continuous) latent variables. This is to define a reflexive factor. 

The "~~" (‘double tilde’) operator specifies (residual) variances of an
observed or latent variable, or a set of covariances.

The "<~" operator can be used to define a formative factor.

The "|" operator can be used to define the thresholds of categorical endogenous
variables.

As in Mplus, you can have multiple variables on the left side of the operator. If you do, you will need to add "+" in between them (if you list them without the "+" (as you would in Mplus), you will get an error message).

## lavaan Defaults to Know About

As in Mplus, this varies by the model being estimated, we'll go over these as needed but all is noted in the lavaan official documentation. Many are identical to Mplus' defaults, but it's worth checking them first.

- Default estimator it maximum likelihood;
- The factor loading of the first indicator of a latent variable is fixed to 1;
- Residual variances are freely estimated;
- All exogenous variables are allowed to covary.

## Fixing covariances in lavaan

Building on the above, you can specifyu an orthogonal (zero) covariance between two latent or observed variables:
f1 ~~ 0*f2 

## If you have categorical indicators

Muthen & Muthen recommend weighted least squares (WLS) when you have many factors and not so many factor indicators. They recommend maximum likelihood(ML, MLR) when you have few factors and many factor indicators. Both MLR and WLS can deal with categorical and continuous outcomes.

## Mplus resources for EFA
### Not just code, the stats too

http://www.statmodel.com/discussion/messages/8/8.html

# Load packages 

```{r}
library(lavaan)# for the loadings
```

# Load file

```{r}
efa_data <- read.table("IH validation 1-21.dat")
```

# Specify the model

```{r}
# these are exploratory blocks (you can give them any name), you'll need to specify them
efa_model <- '
  efa("block1")*F1 =~ V1 + V2 + V3 + V4 + V5 + V6 
  efa("block1")*F2 =~ V1 + V2 + V3 + V4 + V5 + V6
'
```

# Estimate the Model

```{r}
efa_f2 <- 
  sem(model = efa_model,
      data = efa_data,
      rotation = "oblimin",
      estimator = "MLR"
      )
```

# Request the Output

```{r}
summary(efa_f2, 
        fit.measures = TRUE, 
        standardized = TRUE
        )
```
